name: CI - RandomForest-GBM Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-decision-tree:
    name: Test Decision Tree Module
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy matplotlib scikit-learn pytest
    
    - name: Run Decision Tree Tests
      run: |
        python tests/test_classification_tree.py
        python tests/test_regression_tree.py
    
    - name: Run sklearn Comparison
      run: |
        python tests/my_tree_vs_sklearn.py

  test-random-forest:
    name: Test Random Forest Module
    runs-on: ubuntu-latest
    needs: test-decision-tree  # RF depends on DT working
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy matplotlib scikit-learn pytest
    
    - name: Check Random Forest Implementation
      run: |
        # Check if implementation exists (not just TODO)
        if grep -q "NotImplementedError" random_forest/forest.py; then
          echo "⚠️ Random Forest not yet implemented (contains NotImplementedError)"
          echo "This is expected if Member 2 hasn't started yet."
        else
          echo "✅ Random Forest implementation found, running tests..."
          cd random_forest && python -c "from forest import RandomForest; print('Import successful')"
          if [ -f "tests.py" ]; then
            python tests.py
          fi
        fi

  test-gradient-boosting:
    name: Test Gradient Boosting Module
    runs-on: ubuntu-latest
    needs: test-decision-tree  # GBM depends on DT working
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy matplotlib scikit-learn pytest
    
    - name: Check Gradient Boosting Implementation
      run: |
        # Check if implementation exists (not just TODO)
        if grep -q "NotImplementedError" gradient_boosting/gbm.py; then
          echo "⚠️ Gradient Boosting not yet implemented (contains NotImplementedError)"
          echo "This is expected if Member 3 hasn't started yet."
        else
          echo "✅ Gradient Boosting implementation found, running tests..."
          cd gradient_boosting && python -c "from gbm import GradientBoostingMachine; print('Import successful')"
          if [ -f "tests.py" ]; then
            python tests.py
          fi
        fi

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8
    
    - name: Check code style
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Warning for other style issues (non-blocking)
        flake8 . --count --exit-zero --max-complexity=15 --max-line-length=100 --statistics

  protected-folders:
    name: Check Protected Folders
    runs-on: ubuntu-latest
    # Runs on BOTH push and pull_request events
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check folder permissions
      env:
        # TEAM MEMBERS
        MEMBER1: "WE2722"           # Wiam - Decision Tree + Project Lead (can merge all)
        MEMBER2: "AbdellahBaqua"    # Abdellah - Random Forest
        MEMBER3: "Saif-dbot"        # Saif - Gradient Boosting
      run: |
        # Get the actor (person who triggered the workflow)
        ACTOR="${{ github.actor }}"
        EVENT="${{ github.event_name }}"
        
        echo "=============================================="
        echo "Event: $EVENT"
        echo "Actor: $ACTOR"
        echo "=============================================="
        
        # PROJECT LEAD can merge any PR (to integrate team work)
        if [ "$ACTOR" == "$MEMBER1" ]; then
          echo "[OK] Project Lead ($MEMBER1) - authorized to merge all branches"
          exit 0
        fi
        
        # Get changed files based on event type
        if [ "$EVENT" == "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
        else
          # For push events, compare with previous commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only $(git rev-list --max-parents=0 HEAD) HEAD)
        fi
        
        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo "=============================================="
        
        VIOLATIONS=""
        
        # Check decision_tree/ - Only Member 1 (Wiam)
        if echo "$CHANGED_FILES" | grep -q "^decision_tree/"; then
          if [ "$ACTOR" != "$MEMBER1" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] decision_tree/ - Only WE2722 (Wiam) can modify"
          fi
        fi
        
        # Check random_forest/ - ONLY Member 2 (Abdellah)
        if echo "$CHANGED_FILES" | grep -q "^random_forest/"; then
          if [ "$ACTOR" != "$MEMBER2" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] random_forest/ - Only AbdellahBaqua (Abdellah) can modify this folder!"
            VIOLATIONS="$VIOLATIONS\n    You ($ACTOR) are NOT authorized."
          fi
        fi
        
        # Check gradient_boosting/ - ONLY Member 3 (Saif)
        if echo "$CHANGED_FILES" | grep -q "^gradient_boosting/"; then
          if [ "$ACTOR" != "$MEMBER3" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] gradient_boosting/ - Only Saif-dbot (Saif) can modify this folder!"
            VIOLATIONS="$VIOLATIONS\n    You ($ACTOR) are NOT authorized."
          fi
        fi
        
        # Check config files - Only Project Lead (Wiam)
        if echo "$CHANGED_FILES" | grep -qE "^\.github/|^README\.md$|^CONTRIBUTING\.md$"; then
          if [ "$ACTOR" != "$MEMBER1" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] Config files - Only WE2722 (Project Lead) can modify"
          fi
        fi
        
        # =================================================================
        # WIAM'S PROTECTED FILES - Cannot be modified by anyone else
        # =================================================================
        
        # Protected test files (Wiam only)
        WIAM_TESTS="tests/test_classification_tree.py|tests/test_regression_tree.py|tests/my_tree_vs_sklearn.py"
        if echo "$CHANGED_FILES" | grep -qE "$WIAM_TESTS"; then
          if [ "$ACTOR" != "$MEMBER1" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] Wiam's test files are PROTECTED - Only WE2722 can modify them"
          fi
        fi
        
        # Protected image folders (Wiam only)
        WIAM_IMAGES="images/classification/|images/regression/|images/comparison/"
        if echo "$CHANGED_FILES" | grep -qE "$WIAM_IMAGES"; then
          if [ "$ACTOR" != "$MEMBER1" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] Wiam's image folders are PROTECTED - Only WE2722 can modify them"
          fi
        fi
        
        # =================================================================
        # SHARED FOLDERS - All team members can ADD new files
        # =================================================================
        # tests/ and images/ - team members can add NEW files/folders
        # (but cannot modify Wiam's existing files above)
        if echo "$CHANGED_FILES" | grep -qE "^images/|^tests/"; then
          if [ "$ACTOR" != "$MEMBER1" ] && [ "$ACTOR" != "$MEMBER2" ] && [ "$ACTOR" != "$MEMBER3" ]; then
            VIOLATIONS="$VIOLATIONS\n[X] images/ or tests/ - Only team members can modify"
          fi
        fi
        
        if [ -n "$VIOLATIONS" ]; then
          echo ""
          echo "=========================================="
          echo "   PERMISSION VIOLATIONS DETECTED"
          echo "=========================================="
          echo -e "$VIOLATIONS"
          echo ""
          echo "FOLDER OWNERSHIP:"
          echo "  decision_tree/              -> WE2722 (Wiam)"
          echo "  random_forest/              -> AbdellahBaqua (Abdellah)"
          echo "  gradient_boosting/          -> Saif-dbot (Saif)"
          echo "  .github/, configs           -> WE2722 (Project Lead)"
          echo ""
          echo "WIAM'S PROTECTED FILES (untouchable):"
          echo "  tests/test_*.py, tests/my_tree_vs_sklearn.py"
          echo "  images/classification/, images/regression/, images/comparison/"
          echo ""
          echo "SHARED (team can ADD new files):"
          echo "  tests/ (new files)          -> All team members"
          echo "  images/ (new folders)       -> All team members"
          echo "=========================================="
          exit 1
        fi
        
        echo "[OK] All modifications are within allowed folders."
